# Configuración de Docker Compose para la app de gestión de usuario
# Arquitectura de 3 capas: Frontend (nginx) -> Backend (Node.js) -> Base de datos (MySQL)
# 
# Nota: MySQL tarda unos 5 minutos en inicializar completamente la base de datos
# Los servicios arrancan en orden: primero MySQL, luego el backend y finalmente el frontend

services:
  # Frontend: interfaz web con nginx
  # Sirve los archivos estáticos y redirige las peticiones /api al backend
  frontend:
    build:
      context: ./frontend
      dockerfile: Dockerfile
    container_name: gestion-usuarios-frontend
    ports:
      - "80:80"
    stop_grace_period: 5s
    depends_on:
      api:
        condition: service_healthy
    restart: unless-stopped
    networks:
      - app-network

  # Backend: API REST con Node.js
  # Maneja las operaciones CRUD de usuarios y expone endpoint /health para monitoreo
  api:
    build:
      context: ./backend
      dockerfile: Dockerfile
    container_name: gestion-usuarios-api
    stop_grace_period: 5s
    environment:
      - NODE_ENV=production
      - PORT=3000
      - DB_HOST=mysql
      - DB_PORT=3306
      - DB_NAME=users_db
      - DB_USER=root
      - DB_PASSWORD=${DB_PASSWORD:-root123}
    depends_on:
      mysql:
        condition: service_healthy
    healthcheck:
      test: ["CMD", "node", "-e", "require('http').get('http://127.0.0.1:3000/health', r => { r.resume(); process.exit(r.statusCode === 200 ? 0 : 1); }).on('error', () => process.exit(1));"]
      interval: 5s
      timeout: 5s
      retries: 20
      start_period: 60s
    restart: unless-stopped
    networks:
      - app-network

  # Base de datos MySQL
  # IMPORTANTE: Los datos son temporales (sin volumen persistente)
  # El healthcheck verifica que la tabla users esté creada antes de marcar como listo
  # Se da un periodo de gracia de 5 minutos para la inicialización
  mysql:
    image: mysql:8.0
    container_name: gestion-usuarios-db
    stop_grace_period: 5s
    command: --bind-address=0.0.0.0
    environment:
      - MYSQL_ROOT_PASSWORD=${DB_PASSWORD:-root123}
      - MYSQL_DATABASE=users_db
    volumes:
      - ./backend/src/db/init.sql:/docker-entrypoint-initdb.d/init.sql
    ports:
      - "3307:3306"
    healthcheck:
      test: ["CMD", "sh", "-c", "mysql -uroot -p\"$$MYSQL_ROOT_PASSWORD\" users_db -e \"SELECT 1 FROM users LIMIT 1\" || exit 1"]
      interval: 5s
      timeout: 5s
      retries: 15
      start_period: 300s
    restart: unless-stopped
    networks:
      - app-network

# Red interna para comunicación entre servicios
networks:
  app-network:
    driver: bridge
